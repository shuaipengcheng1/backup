## nginx是什么
 是一个高性能的http和反向代理的web服务器
 特点
   占用内存小
   性能高
   高负载

## nginx的基本
1 反向代理
  - 正向代理
     如果把局域网外的因特网想象成一个巨大的资源库 则局域网中的客户端要访问因特网 
     则需要通过代理服务器来访问  这种的代理服务叫做正向代理
     流程:
     客户端 - (请求)-> 代理服务器(ip : www.abc.com) ---> 服务器(ip : www.google.com)
  
  - 反向代理
      其实客户端对代理是无感知的 因为客户端不需要任何的配置就可以访问 我们只需要将求发送给反向代理服务器 由反向代理服务器
      去选择目标服务器获取数据后 在返回给客户端 [测试反向代理服务器和目标服务器对外就是一个服务器] 暴露的代理服务器地址 隐藏了真实服务器IP地址
      流程: 
      用户 ---(请求)--> 反向代理服务器(ip:www.abc.com) ----> 真实服务器(www.xxx.com)  
       通过反向代理 用户是不会知道服务器的真实ip地址的 只会知道反向代理服务器的地址
     
2 负载均衡
  - 客户端发送多个请求到服务器 服务器处理请求
    在并发量小时 可以采取一台机器来响应
    但是如果并发量起来了怎么办呢?
    所以
    增加服务器数量 然后将请求分发到各个服务器上 将原先
    请求集中到单个服务器上的情况改为请求分发到多个服务器上 将负载分发到不同的服务器 也就是我们说的负载均衡
    
    图解
     - 无负载均衡         
          ---> 【
     客户端 -->  服务器
          --->   】
       
     - 负载均衡
                            --> 服务器1
     客户端--> 反向代理服务器   --> 服务器2
                            --> 服务器3
       
     假设客户端同时并发了3000个请求 那么反向代理服务器 会将这3000个请求 平均分配给所有服务器

3 动静分离
  - 为了加载网站的解析速度 可以把动态页面 和 静态页面 分开加载

   图解
    - 传统
    用户 ---> 反向代理服务器 --> 服务器(动态资源(jsp,servlet),静态(html,js,css))
    - 动静分离
    用户 ---> 反向代理服务器 --> 动态资源服务器(jsp,servlet)
                   |
                   |
                  静态资源服务器(css,js,html) 
  

## Linux系统的nginx的安装

 通过yum安装后配置文件路径为
 /etc/nginx/conf.d
 
## 全局配置

配置文件 /etc/nginx/nginx.conf
内容:
user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;
events {
worker_connections  1024;
}
http {
include       /etc/nginx/mime.types;
default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    #tcp_nopush     on;
    keepalive_timeout  65;
    #gzip  on;
    include /etc/nginx/conf.d/*.conf;
}

**从配置文件开始到event快之间的内容 主要会设置一个影响nginx服务器整体运行的配置指令 主要包括配置运行服务器的用户(组) 允许生成的worker process数 进程PID存放路径 日志存放路径 和 类型以及配置文件的引入等**
比如  worker_processes  auto[number];
这是nginx服务器并发处理服务的关键配置 worker process值越大 可以支持的并发量就会更多 但是会受到
硬件软件的制约

**event块 涉及的指令主要影响Nginx服务器与用户的网络链接**
比如 
event{
 worker_connection 1024;   最大连接数
}

**http块 这一个块是涉及的最多的一个块 代理 缓存 日志定义 等绝大部分的功能和第三方的模块的配置都在这里 注意http也可以是server块**
**http块 包括文件引入 MIME-TYPE定义 日志自定义 链接超时时间 单链接请求的上限等**


**server块 这块和虚拟主机有密切关系 虚拟主机从用户角度看 和一台独立的硬件主机是完全一样的 该技术的产生十位了节省互联网的成本**
没以恶搞http块可以包括多个server块 每一个server块就相当于一台虚拟主机
而每一个server也分为全局server 以及可以同时包含多个location块

1 全局server块
最常见的配置 是本虚拟主机的监听配置和本虚拟主机的名称或IP配置
2 location块
语法
location 监听的url{
跳转的规则
}
一个server块 可以配置多个location块
这块的作用是基于nginx服务器接收的请求字符串(例如:server_name/url) 

代码
server{
   listen 80; 监听的端口
   server_name localhost; 服务器名字
   location / {    监听 /
   
    }
}

## 反向代理

1 实现效果
打开浏览器 在浏览器中 输入 192.168.194.128\ 跳转到 linux的tomcat主页

server {
listen       80;
server_name  localhost;
    location / {   //监听 /
        proxy_pass http://192.168.194.128:8080;
     **proxy_pass 表示将该次请求转发给指定的url地址**
    }
}


## 负载均衡
1.实现效果
  浏览器地址输入 地址 http://192.168.194.128/edu 平均到8080和8081端口中
2 nginx配置

（1） 在http块中 设置 upstream属性
        upstream 名称{
    服务器列表
        server 192.168.194.128:8080;
        server 192.168.194.128:8081;
        }

  （2） 设置location跳转到对应的空闲服务器
     server{
     listen 80;
     server_name he;
     location / {
         proxy_pass http://myserver;
     }
     }


## 负载均衡的模式
1 轮询 (默认)
  每一个请求按照顺序分配 若有服务器宕机 那么自动剔除

2 weight (优先级 越高分配越多)
  upstream app {
   server xxx weight=10;
   server xxx weight=5;
  }
3 ip_hash (可以使用户永远访问的是第一次获取的服务器 不会访问其他服务器 可以解决session的丢失问题)
   upstream app{
   ip_hash
  server xxx;
  server xxx;

  }

4 fair (根据服务器的响应时间分配 响应时间越短的优先分配)

upstream app{

server xxx;
server xxx;
fair;

}
   
## 动静分离
 Nginx的动静分离不能单纯的理解为动态页面和静态页面分离 严格来说应该是动态请求跟静态请求的分离 
Nginx处理静态页面 Tomcat处理动态页面 

 动静分离的解析 
 1 动
   一般为指 servlet 或者是要处理数据库的请求 为动态请求
 2 静
   一般为 html 图片 视频等资源 这一类数据为静态请求

动静分离的实现
 第一种方法(最常用)
 动态请求 请求的时候会通过Nginx来将该请求发送给tomcat
 静态请求 一般先会创建一个单独存放静态资源的服务器 并且通过nginx将请求发送给该服务器
 

 第二种方法
  通过location指定 不同的后缀名实现不同的请求转发 通过expires参数设置 
  可以设置浏览器的缓存过期时间 减少服务器的负载 例如
  expires 3d;  
  说明缓存会保存三天 在此期间 不用请求服务器 返回状态码 304
  如果资源变换了 则会自动下载 返回状态码200



## 动静分离的实现
server{
 listen 80;
 server_name he;
  location / {
  root /data/;   root 后面是静态资源的路径
  autoindex on ; 显示该静态资源的所有的文件
  expires 3d;   缓存的时长
  }
}

## nginx配置高可用的集群 

使用场景
 如果nginx宕机了 请求就会无法使用

高可用?
 高可用是指多台nginx服务器
 一台主服务器 
 n台从服务器 
如果主服务器宕机 那么就会自动切换到从服务器
这就是高可用的效果

需要一个软件
keepalive

## 高可用的前提
多台nginx的服务器
需要keepalive

## 开始
两台nginx的服务器环境
192.168.194.128
192.168.194.129
两台服务器安装nginx
并且要安装keepalived

通过yum 安装了keepalived 后 
在 /etc/keepalived/keepalived.conf 中配置主从关系



vrrp_instance VI_1 {
        state BACKUP   //主机为MASTER 从机为BACKUP
        interface eth0
        virtual_router_id 51
        priority 90   // 优先级 从机要比主机低
        advert_int 1
        authentication {
           auth_type PASS
           auth_pass 1111
        }
        virtual_ipaddress {  绑定的虚拟ip(提供给外部访问)
            192.168.200.16
            192.168.200.17
            192.168.200.18
        }
}

启动keepalived 
 systemctl start keepalived.service
启动nginx
nginx




 
 


